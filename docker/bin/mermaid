#!/bin/sh
set -eu
OUT=""
ARGS="$@"
if command -v node >/dev/null 2>&1; then
  PEXEC="$(cd /app && node -e "(async()=>{try{const p=await import('puppeteer');const e=(p.default||p).executablePath?.()||(p.default||p).executablePath; if(e) process.stdout.write(typeof e==='function'?e():e)}catch(e){process.exit(0)}})()" 2>/dev/null || true)"
  if [ -n "${PEXEC:-}" ] && [ -x "$PEXEC" ]; then export PUPPETEER_EXECUTABLE_PATH="$PEXEC"; fi
fi
while [ "$#" -gt 0 ]; do
  case "$1" in
    -o|--output)
      shift || true
      OUT="${1:-}"
      ;;
  esac
  shift || true
done
if [ -n "${OUT}" ]; then
  DIR="$(dirname "${OUT}")"
  mkdir -p "${DIR}" 2>/dev/null || true
fi
export TMPDIR=/tmp
export PUPPETEER_CACHE_DIR=${PUPPETEER_CACHE_DIR:-/opt/puppeteer}
mkdir -p "$PUPPETEER_CACHE_DIR" 2>/dev/null || true
chmod -R a+rx "$PUPPETEER_CACHE_DIR" 2>/dev/null || true
exec /usr/local/bin/mmdc -q -p /usr/local/bin/puppeteer.json ${ARGS}
