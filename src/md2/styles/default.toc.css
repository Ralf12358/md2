/* Minimal, print-friendly theme for Pandoc HTML */
:root {
    --font-body: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
    --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    --color-fg: #24292f;
    --color-muted: #57606a;
    --color-bg: #ffffff;
    --color-border: #d0d7de;
    --color-accent: #0969da;
    --table-header-bg: #f6f8fa;
    --code-bg: #f6f8fa;
    --math-color: #30363d;
    --math-scale: 0.9;
    /* PRINT DENSITY SETTINGS (adjust these to control PDF compactness) */
    --print-base-size: 8.5pt;
    /* Base body font-size when printing */
    --print-line-height: 1.35;
    /* Line height for body text when printing */
    --print-page-padding-block: 8mm;
    /* Top/bottom page padding */
    --print-page-padding-inline: 10mm;
    /* Left/right page padding */
    --print-heading-scale-h1: 1.45;
    /* h1 size multiplier (relative to 1rem) */
    --print-heading-scale-h2: 1.22;
    --print-heading-scale-h3: 1.1;
    --print-heading-scale-h4: 1.0;
    --print-heading-scale-h5: 0.95;
    --print-heading-scale-h6: 0.88;
    --print-block-spacing: 0.65em;
    /* Vertical spacing for paragraphs/lists */
    --print-table-font-scale: 0.88;
    /* Table font-size multiplier */
    --print-table-cell-padding-y: 4px;
    /* Table cell vertical padding */
    --print-table-cell-padding-x: 6px;
    /* Table cell horizontal padding */
    --print-code-font-scale: 0.9;
    /* Code/pre font scaling */
    --print-math-scale: 0.8;
    /* Math formula scaling */

    /* SCREEN heading spacing (top/bottom) */
    --h1-mt: 1.05em;
    --h1-mb: 0.5em;
    --h2-mt: 2.25em;
    --h2-mb: 0.5em;
    --h3-mt: 1.8em;
    --h3-mb: 0.5em;
    --h4-mt: 1.5em;
    --h4-mb: 0.5em;
    --h5-mt: 1.3em;
    --h5-mb: 0.5em;
    --h6-mt: 1.2em;
    --h6-mb: 0.5em;

    /* PRINT heading spacing (top/bottom) */
    --print-h1-mt: 0.9em;
    --print-h1-mb: 0.45em;
    --print-h2-mt: calc(0.9em + 1em);
    --print-h2-mb: 0.45em;
    --print-h3-mt: calc(0.9em + 0.8em);
    --print-h3-mb: 0.45em;
    --print-h4-mt: 0.9em;
    --print-h4-mb: 0.45em;
    --print-h5-mt: 0.9em;
    --print-h5-mb: 0.45em;
    --print-h6-mt: 0.9em;
    --print-h6-mb: 0.45em;
}

html {
    background: var(--color-bg);
    color: var(--color-fg);
}

body {
    font-family: var(--font-body);
    font-size: 15px !important;
    line-height: 1.6;
    margin: 0 auto;
    max-width: 900px;
    padding: 32px 24px;
    counter-reset: h2 h3;
}

/* Screen-only: light grey outside the document area */
@media screen {
    html {
        background: #f3f4f6;
    }

    body {
        background: var(--color-bg);
    }
}

h1,
h2,
h3,
h4,
h5,
h6 {
    line-height: 1.25;
    font-weight: 500;
}

h1 {
    font-size: 1.75rem;
    counter-reset: h2 h3;
    margin: var(--h1-mt) 0 var(--h1-mb);
}

h2 {
    font-size: 1.375rem;
    counter-increment: h2;
    counter-reset: h3;
    margin: var(--h2-mt) 0 var(--h2-mb);
}

h3 {
    font-size: 1.1rem;
    counter-increment: h3;
    margin: var(--h3-mt) 0 var(--h3-mb);
}

h2::before {
    content: counter(h2) " ";
    color: var(--color-muted);
    font-weight: 500;
    margin-right: 0.1em;
}

h3::before {
    content: counter(h2) "." counter(h3) " ";
    color: var(--color-muted);
    font-weight: 500;
    margin-right: 0.1em;
}

/* Ensure Pandoc section wrappers also reset sub-counters */
section.level1 {
    counter-reset: h2 h3;
}

section.level2 {
    counter-reset: h3;
}

h4 {
    font-size: 1.04rem;
    margin: var(--h4-mt) 0 var(--h4-mb);
}

h5 {
    font-size: 0.96rem;
    margin: var(--h5-mt) 0 var(--h5-mb);
}

h6 {
    font-size: 0.9rem;
    color: var(--color-muted);
    margin: var(--h6-mt) 0 var(--h6-mb);
}

/* Adjacent headings: remove extra top margin for deeper subheadings */
h1+h2,
h1+h3,
h1+h4,
h1+h5,
h1+h6,
h2+h3,
h2+h4,
h2+h5,
h2+h6,
h3+h4,
h3+h5,
h3+h6,
h4+h5,
h4+h6,
h5+h6 {
    margin-top: 0;
}

/* Adjacent headings across Pandoc section wrappers */
h1+section.level2>h2:first-child,
h2+section.level3>h3:first-child,
h3+section.level4>h4:first-child,
h4+section.level5>h5:first-child,
h5+section.level6>h6:first-child {
    margin-top: 0;
}

/* Adjacent equal-level headings (siblings) */
h1+h1,
h2+h2,
h3+h3,
h4+h4,
h5+h5,
h6+h6 {
    margin-top: 0;
}

/* Removed over-broad equal-level across-section rule to preserve spacing */

p {
    margin: 0.8em 0;
}

ul,
ol {
    margin: 0.8em 0 0.8em 1.5em;
}

li>ul,
li>ol {
    margin-top: 0.4em;
}

a {
    color: var(--color-accent);
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

img,
svg {
    max-width: 100%;
    height: auto;
    /* Limit diagram height to prevent spanning multiple pages */
    max-height: 85vh;
    /* In print: limit to ~150% of page width or reasonable page height */
}

/* Always center Mermaid diagrams */
svg.mermaid-svg {
    display: block;
    margin-left: auto;
    margin-right: auto;
}

/* List items containing inline math: add breathing room between bullets */
li:has(.katex:not(.katex-display)),
li:has(.mjx-container:not([display="true"])),
li:has(.math.inline) {
    margin-top: 0.7em;
    margin-bottom: 0.7em;
    line-height: 1.7;
}

/* MathJax SVG output tweaks: lighter appearance */
.mjx-svg {
    text-rendering: optimizeLegibility;
    shape-rendering: geometricPrecision;
}

.mjx-container[jax="SVG"] svg {
    overflow: visible;
}

.mjx-container[jax="SVG"] {
    direction: ltr;
    color: var(--math-color);
    font-size: calc(1em * var(--math-scale));
}

.mjx-char {
    shape-rendering: geometricPrecision;
}

.mjx-container[jax="SVG"] path {
    vector-effect: non-scaling-stroke;
}

/* Prevent gaps in extensible delimiters */
.mjx-container {
    line-height: 0 !important;
}

.mjx-container mjx-math {
    line-height: normal;
}

/* Inline math spacing: allow more breathing room in text lines */
.katex:not(.katex-display) {
    line-height: 1.7 !important;
    padding-top: 0.04em;
    padding-bottom: 0.04em;
}

.mjx-container:not([display="true"]) {
    line-height: 1.7 !important;
    padding-top: 0.04em;
    padding-bottom: 0.04em;
}

/* Do not alter display math spacing */
.katex-display,
.katex-display .katex {
    line-height: normal !important;
}

.math.inline {
    line-height: 1.7 !important;
    padding-top: 0.04em;
    padding-bottom: 0.04em;
}


/* Math weight adjustments (reduce perceived boldness) */
/* KaTeX HTML output */
.katex,
.katex * {
    font-weight: 400 !important;
}

.katex .textbf,
.katex .mathbf {
    font-weight: 600 !important;
}

/* MathJax CHTML output */
.mjx-container[jax="CHTML"] {
    font-weight: 400 !important;
}

.mjx-container[jax="CHTML"] .MJX-B,
.mjx-container[jax="CHTML"] .mjx-bold {
    font-weight: 600 !important;
}

/* MathJax SVG output: slightly reduce opacity to appear lighter */
.mjx-container[jax="SVG"] {
    opacity: 0.92;
}


figure {
    margin: 1em 0;
}

figcaption {
    color: var(--color-muted);
    font-size: 0.9em;
    text-align: center;
}

blockquote {
    margin: 1em 0;
    padding: 0.6em 1em;
    border-left: 4px solid var(--color-border);
    color: var(--color-muted);
    background: #fafbfc;
}

code,
kbd,
samp {
    font-family: var(--font-mono);
    font-size: 0.95em;
}

pre {
    background: var(--code-bg);
    padding: 12px 14px;
    overflow: auto;
    border: 1px solid var(--color-border);
    border-radius: 6px;
}

pre code {
    background: transparent;
    padding: 0;
}

table {
    border-collapse: collapse;
    width: 100%;
    font-variant-numeric: tabular-nums;
    font-size: 0.94em;
}

/* Add spacing when one table directly follows another */
table+table {
    margin-top: 1.2em;
}

th,
td {
    border: 1px solid var(--color-border);
    padding: 6px 8px;
    vertical-align: top;
}

thead th {
    background: var(--table-header-bg);
    text-align: left;
}

tbody tr:nth-child(even) {
    background: #fcfcfd;
}

hr {
    border: 0;
    border-top: 1px solid var(--color-border);
    margin: 1.5em 0;
}

/* Math block spacing */
.math.display {
    display: block;
    margin: 1em 0;
}

/* Print adjustments */
@media print {
    body {
        padding: var(--print-page-padding-block) var(--print-page-padding-inline);
        font-size: var(--print-base-size) !important;
        line-height: var(--print-line-height);
    }

    a {
        color: inherit;
        text-decoration: none;
    }

    /* Reduce widow/orphan lines for paragraphs */
    p {
        widows: 3;
        orphans: 3;
        margin: var(--print-block-spacing) 0;
    }

    /* Prefer smart breaks instead of always forcing new pages */
    h1,
    h2 {
        break-before: auto;
        page-break-before: auto;
    }

    /* Defer to smart heading rules; don't force page before sections */
    section.level1,
    section.level2 {
        break-before: auto;
        page-break-before: auto;
    }

    /* Avoid breaking immediately after any heading (keep it with first block) */
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        break-after: avoid;
        page-break-after: avoid;
        margin: 0.9em 0 0.45em;
    }

    h1 {
        font-size: calc(var(--print-heading-scale-h1) * 1rem);
    }

    h2 {
        font-size: calc(var(--print-heading-scale-h2) * 1rem);
    }

    h3 {
        font-size: calc(var(--print-heading-scale-h3) * 1rem);
    }

    h4 {
        font-size: calc(var(--print-heading-scale-h4) * 1rem);
    }

    h5 {
        font-size: calc(var(--print-heading-scale-h5) * 1rem);
    }

    h6 {
        font-size: calc(var(--print-heading-scale-h6) * 1rem);
    }

    /* Extra spacing before h2 in print (~one extra line) */
    h2 {
        margin-top: calc(0.9em + 1em);
    }

    /* Slightly less extra spacing before h3 (~20% less than h2) */
    h3 {
        margin-top: calc(0.9em + 0.8em);
    }

    ul,
    ol {
        margin: var(--print-block-spacing) 0 var(--print-block-spacing) 1.4em;
    }

    table {
        font-size: calc(var(--print-table-font-scale) * 1em);
    }

    th,
    td {
        padding: var(--print-table-cell-padding-y) var(--print-table-cell-padding-x);
    }

    pre {
        font-size: calc(var(--print-code-font-scale) * 1em);
        padding: 8px 10px;
    }

    code,
    kbd,
    samp {
        font-size: calc(var(--print-code-font-scale) * 0.95em);
    }

    :root {
        --math-scale: var(--print-math-scale);
    }

    /* Keep common block elements intact on a page when possible */
    pre,
    blockquote,
    table,
    figure,
    img,
    svg,
    ul,
    ol,
    li,
    .sourceCode,
    .math.display {
        break-inside: avoid;
        page-break-inside: avoid;
    }

    /* Limit diagram height in print to prevent spanning multiple pages */
    img,
    svg {
        max-height: 85vh;
        /* Roughly 85% of viewport height */
        /* Alternative: limit to ~150% of page width */
        max-height: min(85vh, 135mm);
        /* 135mm ≈ 150% of typical page width */
    }

    /* Rows shouldn't break individually */
    tr {
        break-inside: avoid;
        page-break-inside: avoid;
        page-break-after: auto;
    }

    /* Repeat table headers/footers when a table spans pages */
    thead {
        display: table-header-group;
    }

    tfoot {
        display: table-footer-group;
    }

    /* Ensure adjacent tables have a visible gap in print */
    table+table {
        margin-top: calc(var(--print-block-spacing) * 1.5);

    }
}

/* Print: loosen spacing for list items with inline math */
@media print {

    li:has(.katex:not(.katex-display)),
    li:has(.mjx-container:not([display="true"])),
    li:has(.math.inline) {
        margin-top: 0.7em;
        margin-bottom: 0.7em;
        line-height: 1.5;
    }
}

/* Print-only: center first H1 (and direct text after) on page 1 */
@media print {

    /* Horizontally center the title and its immediate paragraph */
    body>h1:first-of-type,
    section.level1:first-of-type>h1:first-of-type,
    body>h1:first-of-type+p,
    section.level1:first-of-type>h1:first-of-type+p {
        text-align: center;
    }

    /* Approximate vertical centering by pushing title down the page */
    body>h1:first-of-type,
    section.level1:first-of-type>h1:first-of-type {
        margin-top: 35vh;
    }

    /* Keep the lead paragraph close to the title */
    body>h1:first-of-type+p,
    section.level1:first-of-type>h1:first-of-type+p {
        margin-top: 0.6em;
    }

    /* Cancel older break-after trick; rely on first H2 break instead */
    body>h1:first-of-type+p::after,
    section.level1:first-of-type>h1:first-of-type+p::after {
        content: none;
        display: none;
        break-after: auto;
        page-break-after: auto;
    }

    /* Move FIRST H2 to the next page to make a proper title page */
    body>h1:first-of-type~h2:first-of-type,
    section.level1:first-of-type>h1:first-of-type~h2:first-of-type {
        break-before: page;
        page-break-before: always;
    }

    /* Keep typical intro blocks intact on the title page */
    body>h1:first-of-type~pre,
    body>h1:first-of-type~table,
    body>h1:first-of-type~figure,
    body>h1:first-of-type~.math.display,
    body>h1:first-of-type~.katex-display,
    body>h1:first-of-type~.mjx-container[display="true"],
    body>h1:first-of-type~p,
    body>h1:first-of-type~ul,
    body>h1:first-of-type~ol,
    body>h1:first-of-type~blockquote,
    section.level1:first-of-type>h1:first-of-type~pre,
    section.level1:first-of-type>h1:first-of-type~table,
    section.level1:first-of-type>h1:first-of-type~figure,
    section.level1:first-of-type>h1:first-of-type~.math.display,
    section.level1:first-of-type>h1:first-of-type~.katex-display,
    section.level1:first-of-type>h1:first-of-type~.mjx-container[display="true"],
    section.level1:first-of-type>h1:first-of-type~p,
    section.level1:first-of-type>h1:first-of-type~ul,
    section.level1:first-of-type>h1:first-of-type~ol,
    section.level1:first-of-type>h1:first-of-type~blockquote {
        break-inside: avoid-page;
        page-break-inside: avoid;
        break-before: avoid-page;
        page-break-before: avoid;
    }

}

nav#TOC,
#TOC,
.toc {
    border: 1px solid var(--color-border);
    background: #fafbfc;
    padding: 16px 18px;
    margin: 1.5em 0;
    counter-reset: toc1;
    font-variant-numeric: tabular-nums;
}

nav#TOC::before,
#TOC::before,
.toc::before {
    content: "Table of Contents";
    display: block;
    font-weight: 500;
    font-size: 1.25rem;
    margin-bottom: 0.6em;
}

nav#TOC ul,
#TOC ul,
.toc ul {
    list-style: none;
    margin: 0;
    padding-left: 0;
}

/* Backlink to TOC appended to headings */
.toc-back {
    font-size: 0.8em;
    margin-left: 0.6em;
    color: var(--color-muted);
    text-decoration: none;
    opacity: 0;
    transition: opacity 0.15s ease-in-out;
}

/* Reveal on hover/focus for accessibility */
h2:hover .toc-back,
h3:hover .toc-back,
h4:hover .toc-back,
h5:hover .toc-back,
h6:hover .toc-back,
.toc-back:focus,
.toc-back:focus-visible,
h2:focus-within .toc-back,
h3:focus-within .toc-back,
h4:focus-within .toc-back,
h5:focus-within .toc-back,
h6:focus-within .toc-back {
    opacity: 1;
}

.toc-back:hover {
    text-decoration: underline;
}

@media print {
    .toc-back {
        display: none !important;
    }
}

nav#TOC li,
#TOC li,
.toc li {
    margin: 0.2em 0;
}

nav#TOC a,
#TOC a,
.toc a {
    text-decoration: none;
    color: inherit;
    display: block;
    position: relative;
}

nav#TOC a:hover,
#TOC a:hover,
.toc a:hover {
    text-decoration: underline;
}

/* TOC page numbers (placeholders for PDF processing) */
body.toc-page-numbers nav#TOC a::after,
body.toc-page-numbers #TOC a::after,
body.toc-page-numbers .toc a::after {
    content: attr(data-toc-placeholder);
    color: #fafbfc !important;
    font-variant-numeric: tabular-nums;
    float: right;
}

nav#TOC>ul>li,
#TOC>ul>li,
.toc>ul>li {
    counter-increment: toc1;
    position: relative;
    padding-left: 3.6em;
}

nav#TOC>ul>li::before,
#TOC>ul>li::before,
.toc>ul>li::before {
    content: counter(toc1) " ";
    color: var(--color-muted);
    position: absolute;
    left: 0;
    width: 3.2em;
    text-align: right;
}

nav#TOC>ul>li>ul,
#TOC>ul>li>ul,
.toc>ul>li>ul {
    counter-reset: toc2;
    margin-left: 1.2em;
}

nav#TOC>ul>li>ul>li,
#TOC>ul>li>ul>li,
.toc>ul>li>ul>li {
    counter-increment: toc2;
    position: relative;
    padding-left: 4.2em;
}

nav#TOC>ul>li>ul>li::before,
#TOC>ul>li>ul>li::before,
.toc>ul>li>ul>li::before {
    content: counter(toc1) "." counter(toc2) " ";
    color: var(--color-muted);
    position: absolute;
    left: 0;
    width: 3.9em;
    text-align: right;
}

nav#TOC>ul>li>ul>li>ul,
#TOC>ul>li>ul>li>ul,
.toc>ul>li>ul>li>ul {
    counter-reset: toc3;
    margin-left: 1.2em;
}

nav#TOC>ul>li>ul>li>ul>li,
#TOC>ul>li>ul>li>ul>li,
.toc>ul>li>ul>li>ul>li {
    counter-increment: toc3;
    position: relative;
    padding-left: 5.0em;
}

nav#TOC>ul>li>ul>li>ul>li::before,
#TOC>ul>li>ul>li>ul>li::before,
.toc>ul>li>ul>li>ul>li::before {
    content: counter(toc1) "." counter(toc2) "." counter(toc3) " ";
    color: var(--color-muted);
    position: absolute;
    left: 0;
    width: 4.7em;
    text-align: right;
}

@media print {

    nav#TOC,
    #TOC,
    .toc {
        break-before: page;
        page-break-before: always;
        break-after: page;
        page-break-after: always;
    }
}

/* Print: slightly increase line-height for inline math to avoid crowding */
@media print {

    .katex:not(.katex-display),
    .mjx-container:not([display="true"]) {
        line-height: 1.5 !important;
        padding-top: 0.06em;
        padding-bottom: 0.06em;
    }

    .katex-display,
    .katex-display .katex {
        line-height: normal !important;
    }

    .math.inline {
        line-height: 1.5 !important;
        padding-top: 0.06em;
        padding-bottom: 0.06em;
    }
}

@media print {

    /* Smart keep-with-next for headings: keep heading with first block (exclude first H1) */
    h1:not(:first-of-type)+*,
    h2+*,
    h3+*,
    h4+*,
    h5+*,
    h6+* {
        break-before: avoid-page;
        page-break-before: avoid;
        break-inside: avoid-page;
        page-break-inside: avoid;
    }

    /* Stronger protection for common large blocks after a heading (exclude first H1) */
    h1:not(:first-of-type)+.math.display,
    h2+.math.display,
    h3+.math.display,
    h4+.math.display,
    h5+.math.display,
    h6+.math.display,
    h1:not(:first-of-type)+.katex-display,
    h2+.katex-display,
    h3+.katex-display,
    h4+.katex-display,
    h5+.katex-display,
    h6+.katex-display,
    h1:not(:first-of-type)+.mjx-container[display="true"],
    h2+.mjx-container[display="true"],
    h3+.mjx-container[display="true"],
    h4+.mjx-container[display="true"],
    h5+.mjx-container[display="true"],
    h6+.mjx-container[display="true"],
    h1:not(:first-of-type)+pre,
    h2+pre,
    h3+pre,
    h4+pre,
    h5+pre,
    h6+pre,
    h1:not(:first-of-type)+table,
    h2+table,
    h3+table,
    h4+table,
    h5+table,
    h6+table,
    h1:not(:first-of-type)+figure,
    h2+figure,
    h3+figure,
    h4+figure,
    h5+figure,
    h6+figure,
    h1:not(:first-of-type)+ul,
    h2+ul,
    h3+ul,
    h4+ul,
    h5+ul,
    h6+ul,
    h1:not(:first-of-type)+ol,
    h2+ol,
    h3+ol,
    h4+ol,
    h5+ol,
    h6+ol {
        break-before: avoid-page;
        page-break-before: avoid;
        break-inside: avoid-page;
        page-break-inside: avoid;
    }

    /* Keep heading + short lead paragraph together with the next large block */
    h1:not(:first-of-type)+p:has(+ :is(table, figure, pre, ul, ol, .math.display, .katex-display, .mjx-container[display="true"])),
    h2+p:has(+ :is(table, figure, pre, ul, ol, .math.display, .katex-display, .mjx-container[display="true"])),
    h3+p:has(+ :is(table, figure, pre, ul, ol, .math.display, .katex-display, .mjx-container[display="true"])),
    h4+p:has(+ :is(table, figure, pre, ul, ol, .math.display, .katex-display, .mjx-container[display="true"])),
    h5+p:has(+ :is(table, figure, pre, ul, ol, .math.display, .katex-display, .mjx-container[display="true"])),
    h6+p:has(+ :is(table, figure, pre, ul, ol, .math.display, .katex-display, .mjx-container[display="true"])) {
        break-after: avoid-page;
        page-break-after: avoid;
    }
}

/* Print: top-priority rule — never break at headings */
@media print {

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        break-inside: avoid-page;
        page-break-inside: avoid;
    }

    /* Adjacent headings across Pandoc section wrappers (print) */
    h1+section.level2>h2:first-child,
    h2+section.level3>h3:first-child,
    h3+section.level4>h4:first-child,
    h4+section.level5>h5:first-child,
    h5+section.level6>h6:first-child {
        margin-top: 0;
    }

    /* Adjacent headings in print: remove extra top margin for deeper subheadings */
    h1+h2,
    h1+h3,
    h1+h4,
    h1+h5,
    h1+h6,
    h2+h3,
    h2+h4,
    h2+h5,
    h2+h6,
    h3+h4,
    h3+h5,
    h3+h6,
    h4+h5,
    h4+h6,
    h5+h6 {
        margin-top: 0;
    }
}

/* Print: allow TOC to split across pages (override global list rules) */
@media print {

    nav#TOC ul,
    nav#TOC ol,
    nav#TOC li,
    #TOC ul,
    #TOC ol,
    #TOC li,
    .toc ul,
    .toc ol,
    .toc li {
        break-inside: auto;
        page-break-inside: auto;
    }
}
